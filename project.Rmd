---
title: "Memory analysis"
output:
  html_notebook:
    css: style.css
  html_document:
    df_print: paged
    css: style.css
---
## Introduction
Currently the use of smartphone a electronic devices is 


## Libraries
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyr)
library(ggplot2)
library(dplyr)
library(mongolite)
library(modelr)
library(cowplot)
```

```{r include=FALSE}
mytheme<-theme_void()+
        theme(
          panel.background = element_rect(fill = "#0c1329",colour = NA_character_),# necessary to avoid drawing panel outline
         plot.background = element_rect(fill = "#0c1329",,colour = NA_character_),
         legend.text = element_text(colour = "white"),
         legend.title = element_text(face = "bold", colour = "white"),
         plot.title = element_text(face = "bold", colour = "white"),
         legend.box.background = element_rect(fill = "#0c1329", color= "#0c1329"),
          axis.text=element_text(colour = "white"),
         axis.title=element_text(colour = "white")) 
themeBars<- theme( axis.text=element_text(colour = "white"),
         panel.grid.major = element_line(colour = "white"),
         panel.grid.minor = element_line(colour = "white"))
colors=c( "#5F00AD",
    "#7700B8",
    "#7E00C2",
    "#7D00B8",
    "#8700B8",
    "#9900B8",
    "#9A00A8",
    "#A30096",
    "#A8007B",
    "#B30071",
    "#B30056",
    "#A80051",
    "#C20067",
    "#CC0074",
    "#FF05A8",
    "#FF2E8C",
    "#FF584D",
    "#FF7857",
    "#FFAE57",
    "#FFC466",
    "#FFDE85",
    "#FFF4B8",
    "#FAFFC2")
colorSex=c("#FF7857","#5F00AD")
pink= "#FF2E8C"
```

# Questions
- What is the average response time by gender and by age ?
- What is the  average moves require to open the 12 pairs of cards?
- There is a relationship between age or gender that determinate the average time to open all cards?
- There is a pattern in the order of open card ?
- There is a improvement in the  persons how play the game many time?

# Exporting Data
```{r include=FALSE}
urldb='mongodb+srv://admin:AvrilFG123@mystore.96rrl.mongodb.net/game-memory?retryWrites=true&w=majority'
```

```{r}

connectionGames = mongo(collection="games", url=urldb)
connectionUsers = mongo(collection="users", url=urldb)
connectionMoves = mongo(collection="moves", url=urldb)

games <- connectionGames$find('{}',fields = '{"user":true}')%>%as_tibble()
user <- connectionUsers$find('{}',fields = '{"age" : true,"sex":true,"email":true}')%>%as_tibble()
moves <- connectionMoves$find('{}')%>%as_tibble()
```


```{r}

separateList <- function(df,column, names){
  return(
    df%>%unnest(column )%>%
      group_by(id) %>% 
      mutate(col=names) %>% #add a column indicator
      spread(key=col, value=column)
  )
}
```



```{r result=FALSE}

 full_table<-moves %>% mutate(id = 1:nrow(moves)) %>% 
  separateList('card1',c('x1','y1','emoji1')) %>%   
  separateList('card2',c('x2','y2','emoji2')) %>%
  inner_join(games, by=c("game"="_id"))%>%
  left_join(user,by=c("user"="_id"))
full_table$id=NULL

```


```{r echo=TRUE, message=FALSE, warning=FALSE}
user_summarise <- full_table %>%
    arrange(start) %>% 
    group_by(game, user, sex ) %>% 
    mutate(time=end-start) %>%
    summarise(count = n(),
              mean = mean(time), 
              score=mean(match), 
              start_game=first(start), 
              end_game=last(end), 
              firstEmoji=first(emoji1),
              secondEmoji=nth(emoji1,2),
              thirdEmoji=nth(emoji1,3),
              last2Emoji=nth(emoji1,-3),
              last1Emoji=nth(emoji1,-2),
              lastEmoji=last(emoji1)
              , .groups = 'drop') %>% 
              arrange(start_game)%>%
  group_by(user)%>%
  mutate(game=row_number(), 
         duration=end_game-start_game)
user_summarise
```
```{r}
ggplot(data=user_summarise)+
  geom_bar(mapping = aes(x = reorder(user,-game), fill = sex))+
  theme_void()+
  scale_fill_manual(values=colorSex)+
  mytheme+
  themeBars+
  theme(axis.text.x=element_blank())+
  ylab('# games')+
  xlab('user')
```

```{r}
ggplot(data=user_summarise, mapping = aes(x = start_game, y=score, color=user))+
  geom_point(size=3)+theme_void()+mytheme+themeBars
```

```{r}
first_emoji<-user_summarise%>%
  group_by(firstEmoji)%>%
  summarise(count= n())%>%
  ggplot(aes(x = reorder(firstEmoji,-count),y=count))+
    geom_bar(stat="identity", mapping=aes( fill=count))+
  scale_fill_distiller(palette = "RdPu" )+
  mytheme+
  themeBars+
  ggtitle('First open emoji')+  
  xlab('emoji')+
  theme(legend.position = "none")
last_emoji<-user_summarise%>%
  group_by(lastEmoji)%>%
  summarise(count= n())%>%
  ggplot(aes(x = reorder(lastEmoji,-count),y=count))+
    geom_bar(stat="identity", mapping=aes(fill=count))+
  scale_fill_distiller(values = "RdPu" )+
  mytheme+
  themeBars+
  ggtitle('Last open emoji')+ 
  xlab('emoji')+
  theme(legend.position = "none")
plot_grid(first_emoji,last_emoji,nrow=1, ncol=2) + 
  theme(plot.background = element_rect(fill="#0c1329", color = NA))
```



```{r}
user_summarise <- user_summarise %>% 
  group_by(user) %>%
  summarise(number_games=n())%>%
  inner_join(user_summarise,by=c('user'='user'))%>%
  mutate(ranges=cut(count,seq(8, 48, 4)))
```


```{r}
full_table%>%
  ggplot(aes(x1,y1))+
  geom_bin_2d()+ 
  scale_fill_distiller(palette = "RdPu")+
  theme_void()+mytheme
```

```{r}
emo1_emo2<-full_table%>%select(emoji1,emoji2)

matriz_emojis<-xtabs( ~ emoji1+emoji2, data=emo1_emo2)

matriz_emojis<-matriz_emojis+t(matriz_emojis) # taking advantage of  the symmetry  we can add  the transposed to count (1,2) (2,1) as one

comp<-matriz_emojis
diag(comp)<-0

as.data.frame(comp)%>%
 ggplot(aes(emoji1,emoji2, fill=Freq))+
  geom_bin_2d()+scale_fill_distiller(palette = "RdPu")+
  theme_void()+
  mytheme+
  themeBars

matriz_emojis <- 1 / matriz_emojis 
diag(matriz_emojis)<-0
matriz_emojis[upper.tri(matriz_emojis)] <- 0

plot(hclust(as.dist(matriz_emojis)))
emojis<-as.data.frame(matriz_emojis)%>%mutate(Freq=1/Freq)
most_common_pairs<-emojis%>%filter(Freq!=Inf)%>% group_by(emoji1)%>%mutate(max=max(Freq))%>%filter(Freq==max)
most_common_pairs%>%
  graph_from_data_frame()%>%
  ggraph(layout = 'sugiyama') +
  geom_edge_link(aes(colour = Freq)) +
  geom_node_point(color = "pink", size = 2) +
  geom_node_text(aes(label = name),colour='white',size=6 ,repel = TRUE) +
  scale_edge_color_distiller(palette = 'Set1')+
  mytheme+theme(
    axis.text.y=element_blank(),
    axis.text.x=element_blank(),
    axis.title = element_blank())

```

```{r include=FALSE}
emojis =sort(unique(full_table$emoji1))
emojisId=1:length(emojis)
names(emojisId)=emojis
```

```{r}
more_games_2=user_summarise%>%mutate(duration= as.numeric(duration))

mod <- lm(score ~ log(duration), data = more_games_2)
more_games_2%>%
  add_predictions(mod)%>%
  ggplot(aes(duration,score))+
  geom_point(color=pink)+
  geom_line(aes(duration,pred ),color='green')+
  ggtitle('Score by Game Duration')+
  xlab('Time (s)')+
  ylab('Score')+
  mytheme+
  themeBars
cor(as.numeric(more_games_2$duration),more_games_2$score)

summary(mod)
```


```{r}
user_summarise %>%
  filter(game<=10) %>%
  ggplot(aes(game,score, group=game))+
  geom_boxplot( fill = pink, colour = "white")+
  ggtitle("Score by game")+
  mytheme+
  themeBars
```

```{r}
user_summarise%>%filter(score>=0.5)%>%ggplot(aes(mean,score,colour=sex))+geom_point()
```

```{r}
more_games<-user_summarise%>%filter(number_games>=4)
less_games<-user_summarise%>%filter(number_games<4)
rangesM<-sort(unique(user_summarise$ranges))
colorsRanges=rev(colors)
names(colorsRanges)=levels(rangesM)
more_games_percentage<-more_games%>% 
  group_by(ranges) %>%
  summarise(total= n()) %>% # Compute total
  mutate(fraction = total/sum(total), # Compute percentages
         ymax=cumsum(fraction)) # Compute the cumulative percentages (top of each rectangle)
more_games_percentage<-more_games_percentage%>%
  mutate(
    ymin=c(0,head(more_games_percentage$fraction,n=-1)))%>% # Compute the bottom of each rectangle
  mutate(
    labePosition=(ymax+ymin)/2, # Compute label position
    label=ifelse(fraction>0.2,paste0(ranges," \n value: ",round(fraction*100), '%'),'') # Compute label only for percentage grater than 20%
    )
# Creation graph
more_games_percentage<-more_games_percentage%>%arrange(fraction)
 more_games_moves<-ggplot(more_games_percentage, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=ranges)) +
  geom_rect(color='white') +
  coord_polar(theta="y") +
  geom_text(
            aes(x=1 ,
                y=labePosition, 
                label=label, 
                color=ranges), 
            size=4)+  #
  xlim(c(-1, 4)) +
  theme_void() +
  scale_fill_manual(values = colorsRanges)+
  scale_color_manual(values = colorsRanges)+
  theme(legend.position = "none")+mytheme
 

less_games_percentage<-less_games%>% 
  group_by(ranges) %>%
  summarise(total= n()) %>% 
  mutate(fraction = total/sum(total),
         ymax=cumsum(fraction))
less_games_percentage<-less_games_percentage%>%
  mutate(
    ymin=c(0,head(less_games_percentage$fraction,n=-1)))%>%
  mutate(
    labePosition=(ymax+ymin)/2,
    label=ifelse(fraction>0.2,paste0(ranges," \n value: ",round(fraction*100), '%'),'') 
    )

less_games_percentage<-less_games_percentage%>%arrange(fraction)
 less_games_moves<-ggplot(less_games_percentage, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=ranges)) +
  geom_rect(color='white') +
  coord_polar(theta="y") +
  geom_text(
            aes(x=1 ,
                y=labePosition, 
                label=label, 
                color=ranges), 
            size=4)+  #
  xlim(c(-1, 4)) +
  theme_void() +
  scale_fill_manual(values = colorsRanges)+
  scale_color_manual(values = colorsRanges)+mytheme


plot_grid(more_games_moves,less_games_moves,nrow=1, ncol=2) + 
  theme(plot.background = element_rect(fill="#0c1329", color = NA))
user_summarise%>%
  group_by(user,number_games)%>%
  summarise(mean_score=mean(score))%>%
  arrange(number_games)%>%
  ggplot(aes(number_games,mean_score))+
  geom_point()
```

```{r}
gian<-more_games%>%filter(user=='6267cf94afe2b9dff26e8952')%>%
  arrange(start_game)%>%
  mutate(id = 1:nrow(more_games
                     %>%filter(user=='6267cf94afe2b9dff26e8952'))) %>%
  select(id, everything())
gian %>% 
  ggplot(aes(x = id, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
gian %>% 
  ggplot(aes(x = mean, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
cor(as.numeric(gian$mean),gian$score)
cor(as.numeric(gian$start_game),gian$score)
gian_mod <- lm(score ~ id, data = gian)
gian_mod2 <- lm(score ~ log(id), data = gian)
summary(gian_mod)
summary(gian_mod2)
gian %>% 
  ggplot(aes(x = start_game, y=mean, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")

gian%>% 
  add_predictions(gian_mod2)%>%
  ggplot(aes(x = id, y=score))+
  geom_point()+
  geom_abline(intercept = gian_mod$coefficients[1], 
              slope = gian_mod$coefficients[2], 
               color = "red")+
   geom_line(aes(id,pred))
```



```{r eval=FALSE, include=FALSE}
rita<-more_games%>%filter(user=='6267d02aafe2b9dff26e8983')%>%
  arrange(start_game)%>%
  mutate(id = 1:nrow(more_games%>%filter(user=='6267d02aafe2b9dff26e8983'))) %>%
  select(id, everything())
rita %>% 
  ggplot(aes(x = start_game, y=score)) + 
  geom_line() 
rita %>% 
  ggplot(aes(x = mean, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
rita %>% 
  ggplot(aes(x = start_game, y=mean, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
rita_mod <- lm(score ~ id, data = rita)
rita_mod2 <- lm(score ~ log(id), data = rita)
summary(rita_mod)
summary(rita_mod2)
rita %>%  add_predictions(rita_mod2)%>%
  ggplot(aes(x = id, y=score)) + 
  geom_point() +
  geom_abline(intercept = rita_mod$coefficients[1], 
              slope = rita_mod$coefficients[2], 
              color = "red")+
  geom_line(aes(id,pred))
```


In the last two graphs we can observe there is an interesting pattern, periodic increase and decrease in the score. Also we can observe there are some days when the score is bigger so should we should  try to discover if there is and special day of the weekend 

```{r eval=FALSE, include=FALSE}
user_summarise%>%filter(game<=10)%>%mutate(wday = wday(start_game, label = TRUE))%>%
ggplot( aes(wday, score)) + 
  geom_boxplot(fill = pink, colour = "white")+
  ggtitle("Score by week day")+
  mytheme+
  themeBars
```
```{r eval=FALSE, include=FALSE}

rita%>%mutate(wday = wday(start_game, label = TRUE))%>%
  ggplot( aes(wday, count)) + 
    geom_boxplot()+ 
    ggtitle("Score by week day rita")
gian%>%mutate(wday = wday(start_game, label = TRUE))%>%
  ggplot( aes(wday, count)) + 
  geom_boxplot()+ 
  ggtitle("Score by week day gian")

rita%>%mutate(wday = wday(start_game, label = TRUE))%>%
  filter(!wday %in% c( "mar"))%>%ggplot( aes(start_game, score)) + 
  geom_line() +
  geom_smooth(se = FALSE, span = 0.20)

gian%>%mutate(wday = wday(start_game, label = TRUE))%>%
  filter(!wday %in% c( "ven"))%>%ggplot( aes(start_game, score)) + 
  geom_line() +
  geom_smooth(se = FALSE, span = 0.20)
gian %>%
  mutate(wday = hour(start_game))%>%
  ggplot( aes(wday, score, group=wday)) + 
    geom_boxplot()+ 
    ggtitle("Score by hour day gian")

rita %>%
  mutate(wday = hour(start_game))%>%
  ggplot( aes(wday, score, group=wday))+ 
    geom_boxplot()+ 
    ggtitle("Score by hour day rita")


```


Watching for a long time we can observer some interesting details seems there is break point where the score stops and remain almost the same in range


There is a relationship between the emojis of in the game and the score?
```{r eval=FALSE, include=FALSE}
ggplot(more_games, aes( score)) +
    geom_bar() +
    theme_classic()
ggplot(less_games,aes (score)) +
    geom_bar() +
  theme_classic()
by_game<-full_table%>%group_by(user,game)%>%nest()

# Grafico person play more than 6 times
full_table %>%
  arrange(start)%>%
  filter(game=="62949d54a7d555019e4fbd40") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62949d54a7d555019e4fbd40")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 
full_table %>%
  arrange(start)%>%
  filter(game=="62b1a3d548995315b410f15d") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62b1a3d548995315b410f15d")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 
full_table %>%
  arrange(start)%>%
  filter(game=="6284d0c08a106117bf6804a7") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="6284d0c08a106117bf6804a7")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 

# Grafico person play less  than 6 times
full_table %>%
  arrange(start)%>%
  filter(game=="62716168a67e5db825954be9") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62716168a67e5db825954be9")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 
full_table%>%group_by(game)%>%
  mutate(id=row_number(),time = as.numeric(end-start))%>%filter(game %in% less_games$game)%>%
  ggplot()+
  geom_point(aes(id,time))
full_table%>%group_by(game)%>%
  mutate(id=row_number(),time = as.numeric(end-start))%>%
  filter(game %in% less_games$game)%>%
  ggplot(aes(id,time))+  
  geom_line(aes(group = user, color=user), alpha = 1/3) 
```
```{r}
more_games%>%group_by(sex,user)%>% summarise(n=n())%>%group_by(sex)%>%summarise(c=n())
```



