---
title: "Memory analysis"
output: html_notebook
---
# Libraries
```{r include=FALSE}
library(tidyr)
library(readr)
library(ggplot2)
library(dplyr)
library(mongolite)
library(modelr)
library(corrplot)
library(cluster)
library(gridExtra)
library(igraph)
library(lubridate)
#install.packages('igraph')
#install.packages('ggraph')
#install.packages('lubridate')
```
# Questions
- What is the average response time by gender and by age ?
- What is the  average moves require to open the 12 pairs of cards?
- There is a relationship between age or gender that determinate the average time to open all cards?
- There is a pattern in the order of open card ?
- There is a improvement in the  persons how play the game many time?

# Exporting Data
```{r}
urldb='mongodb+srv://admin:AvrilFG123@mystore.96rrl.mongodb.net/game-memory?retryWrites=true&w=majority'
connectionGames = mongo(collection="games", url=urldb)
connectionUsers = mongo(collection="users", url=urldb)
connectionMoves = mongo(collection="moves", url=urldb)

games <- connectionGames$find('{}',fields = '{"user":true}')%>%as_tibble()
user <- connectionUsers$find('{}',fields = '{"age" : true,"sex":true,"email":true}')%>%as_tibble()
moves <- connectionMoves$find('{}')%>%as_tibble()
```


```{r}

separateList <- function(df,column, names){
  return(
    df%>%unnest(column )%>%
      group_by(id) %>% 
      mutate(col=names) %>% #add a column indicator
      spread(key=col, value=column)
  )
}
```



```{r}
 full_table<-moves %>% mutate(id = 1:nrow(moves)) %>% 
  separateList('card1',c('x1','y1','emoji1')) %>%   
  separateList('card2',c('x2','y2','emoji2')) %>%
  inner_join(games, by=c("game"="_id"))%>%
  inner_join(user,by=c("user"="_id"))
full_table$id=NULL

```


```{r}
user_summarise <- full_table %>%
    arrange(start) %>% 
    group_by(game, email, sex ) %>% 
    mutate(time=end-start) %>%
    summarise(count = n(),
              mean = mean(time), 
              score=mean(match), 
              start_game=first(start), 
              end_game=last(end), 
              firstEmoji=first(emoji1),
              secondEmoji=nth(emoji1,2),
              thirdEmoji=nth(emoji1,3),
              last2Emoji=nth(emoji1,-3),
              last1Emoji=nth(emoji1,-2),
              lastEmoji=last(emoji1)
              ) %>% 
              arrange(-count)
```
```{r}
ggplot(data=user_summarise)+
  geom_bar(mapping = aes(x = email, fill = sex))
```

```{r}
ggplot(data=user_summarise, mapping = aes(x = start_game, y=score, color=email))+
  geom_point()
```
```{r}
ggplot(data=full_table) +
  geom_bar(mapping = aes(x = sex, fill = match))
full_table%>%group_by(game,sex)%>%summarise(moves=n())%>%group_by(sex)%>%summarise(n())
```
```{r}
colors1=c( "#5F00AD",
    "#7700B8",
    "#7E00C2",
    "#7D00B8",
    "#8700B8",
    "#9900B8",
    "#9A00A8",
    "#A30096",
    "#A8007B",
    "#B30071",
    "#B30056",
    "#A80051",
    "#C20067",
    "#CC0074",
    "#FF05A8",
    "#FF2E8C",
    "#FF584D",
    "#FF7857",
    "#FFAE57",
    "#FFC466",
    "#FFDE85",
    "#FFF4B8",
    "#FAFFC2")
user_summarise%>%
  arrange(firstEmoji)%>%
    ggplot() + geom_bar(mapping = aes(x = firstEmoji,fill=firstEmoji))+
  scale_fill_manual(values = colors1)
user_summarise%>%
  arrange(firstEmoji)%>%
  ggplot()+
    geom_bar(mapping = aes(x = lastEmoji,fill=lastEmoji))+
  scale_fill_manual(values = colors1)

```



```{r}
user_summarise <- user_summarise %>% 
  group_by(email) %>%
  summarise(number_games=n())%>%
  inner_join(user_summarise,by=c('email'='email'))%>%
  mutate(ranges=cut(count,seq(8, 48, 4)))
```

```{r}
colors=c( "#5F00AD",
    "#7700B8",
    "#7E00C2",
    "#7D00B8",
    "#8700B8",
    "#9900B8",
    "#9A00A8",
    "#A30096",
    "#A8007B",
    "#B30071",
    "#B30056",
    "#A80051",
    "#C20067",
    "#CC0074",
    "#FF05A8",
    "#FF2E8C",
    "#FF584D",
    "#FF7857",
    "#FFAE57",
    "#FFC466",
    "#FFDE85",
    "#FFF4B8",
    "#FAFFC2")
```


```{r}
more_games<-user_summarise%>%filter(number_games>=6)
less_games<-user_summarise%>%filter(number_games<6)
rangesM<-sort(unique(user_summarise$ranges))
names(colors)=levels(rangesM)

less_games_moves<-less_games%>% 
  group_by(ranges) %>%
  summarise(total= n()) %>%
  ggplot( aes(x = 2, y = total, fill =ranges)) +
  geom_bar(stat = "identity", color = "white") +
   ggtitle('less than 6 games')+
  coord_polar("y",start=0)+
  xlim(0.5, 2.5)+
  theme_void()+
  scale_fill_manual(values = colors)

more_games_moves<-more_games%>% 
  group_by(ranges) %>%
  summarise(total= n()) %>%
  ggplot( aes(x = 2, y = total, fill = ranges)) +
  geom_bar(stat = "identity", color = "white") +
  ggtitle('6 or more games')+
  coord_polar("y",start=0)+
  xlim(0.5, 2.5)+
  theme_void()+
  scale_fill_manual(values = colors)+
  theme(legend.position = "none")
grid.arrange(more_games_moves,less_games_moves,nrow=1, ncol=2)

```

```{r}
full_table%>%
  ggplot(aes(x1,y1))+
  geom_bin_2d()
full_table%>%
  ggplot(aes(x2,y2))+
  geom_bin_2d()

```

```{r}
emojis =sort(unique(full_table$emoji1))



n<-full_table%>%select(emoji1,emoji2)
l<-xtabs( ~ emoji1+emoji2, data=n)

plot(hclust(dist(l,method = 'euclidean')))

full_table%>%
 ggplot(aes(emoji1,emoji2))+
  geom_bin_2d()+scale_fill_distiller(palette = "Spectral")
```

```{r}
emojis =sort(unique(full_table$emoji1))
emojisId=1:length(emojis)
names(emojisId)=emojis

n<-full_table%>%filter(sex=="male")%>%select(emoji1,emoji2)
l<-xtabs( ~ emoji1+emoji2, data=n)
l
plot(hclust(dist(l,method = 'euclidean')),main= "male")

n<-full_table%>%filter(sex=="female")%>%select(emoji1,emoji2)
l<-xtabs( ~ emoji1+emoji2, data=n)

plot(hclust(dist(l,method = 'euclidean')), main= "female")


```

```{r}


```



```{r}
gian<-more_games%>%filter(email=='gperfects02@gmail.com')%>%
  arrange(start_game)%>%
  mutate(id = 1:nrow(more_games
                     %>%filter(email=='gperfects02@gmail.com'))) %>%
  select(id, everything())
gian %>% 
  ggplot(aes(x = id, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
gian %>% 
  ggplot(aes(x = mean, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
gian %>% 
  ggplot(aes(x = start_game, y=mean, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")

gian%>% 
  add_predictions(gian_mod2)%>%
  ggplot(aes(x = id, y=score))+
  geom_point()+
  geom_abline(intercept = gian_mod$coefficients[1], 
              slope = gian_mod$coefficients[2], 
               color = "red")+
   geom_line(aes(id,pred))
cor(as.numeric(gian$mean),gian$score)
cor(as.numeric(gian$start_game),gian$score)
gian_mod <- lm(score ~ id, data = gian)
gian_mod2 <- lm(score ~ log(id), data = gian)
summary(gian_mod)
summary(gian_mod2)
```



```{r}
rita<-more_games%>%filter(email=='ritamorocutti@gmail.com')%>%
  arrange(start_game)%>%
  mutate(id = 1:nrow(more_games%>%filter(email=='ritamorocutti@gmail.com'))) %>%
  select(id, everything())
rita %>% 
  ggplot(aes(x = start_game, y=score)) + 
  geom_line() 
rita %>% 
  ggplot(aes(x = mean, y=score, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
rita %>% 
  ggplot(aes(x = start_game, y=mean, fill="blue")) + 
  geom_line()+
   geom_smooth(method = "loess")
rita_mod <- lm(score ~ id, data = rita)
rita_mod2 <- lm(score ~ log(id), data = rita)
summary(rita_mod)
summary(rita_mod2)
rita %>%  add_predictions(rita_mod2)%>%
  ggplot(aes(x = id, y=score)) + 
  geom_point() +
  geom_abline(intercept = rita_mod$coefficients[1], 
              slope = rita_mod$coefficients[2], 
              color = "red")+
  geom_line(aes(id,pred))
```


In the last two graphs we can observe there is an interesting pattern, periodic increase and decrease in the score. Also we can observe there are some days when the score is bigger so should we should  try to discover if there is and special day of the weekend 

```{r}
more_games<-more_games%>%mutate(wday = wday(start_game, label = TRUE))
ggplot(more_games, aes(wday, count)) + 
  geom_boxplot()

ggplot(more_games, aes(wday,as.numeric(mean))) + 
  geom_boxplot()

less_games<-less_games%>%mutate(wday = wday(start_game, label = TRUE))
ggplot(less_games, aes(wday, count)) + 
  geom_boxplot()


```
```{r}

rita%>%mutate(wday = wday(start_game, label = TRUE))%>%ggplot( aes(wday, count)) + 
  geom_boxplot()
gian%>%mutate(wday = wday(start_game, label = TRUE))%>%ggplot( aes(wday, count)) + 
  geom_boxplot()
rita%>%mutate(wday = wday(start_game, label = TRUE))%>%
  filter(!wday %in% c( "mar"))%>%ggplot( aes(start_game, score)) + 
  geom_line() +
  geom_smooth(se = FALSE, span = 0.20)
gian%>%mutate(wday = wday(start_game, label = TRUE))%>%
  filter(!wday %in% c( "ven"))%>%ggplot( aes(start_game, score)) + 
  geom_line() +
  geom_smooth(se = FALSE, span = 0.20)

```


Watching for a long time we can observer some interesting details seems there is break point where the score stops and remain almost the same in range


There is a relationship between the emojis of in the game and the score?
```{r}
ggplot(more_games, aes( score)) +
    geom_bar() +
    theme_classic()
ggplot(less_games,aes (score)) +
    geom_bar() +
  theme_classic()
by_game<-full_table%>%group_by(email,game)%>%nest()

full_table %>%
  arrange(start)%>%
  filter(game=="62716004a67e5db825954b77") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62716004a67e5db825954b77")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 
full_table %>%
  arrange(start)%>%
  filter(game=="62716168a67e5db825954be9") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62716168a67e5db825954be9")))%>%
  ggplot(aes(start,id))+  
  geom_point()+
  geom_segment(aes(xend =end , yend = id)) 
full_table%>%group_by(game)%>%
  mutate(id=row_number(),time = as.numeric(end-start))%>%filter(game %in% less_games$game)%>%
  ggplot()+
  geom_point(aes(id,time))
full_table%>%group_by(game)%>%
  mutate(id=row_number(),time = as.numeric(end-start))%>%
  filter(game %in% less_games$game)%>%
  ggplot(aes(id,time))+  
  geom_line(aes(group = email, color=email), alpha = 1/3) 
```

```{r}
full_table %>%
  arrange(start)%>%
  filter(game=="62716168a67e5db825954be9") %>%
  mutate(time = as.numeric(end-start) ,
         id=1:nrow(full_table %>%
    filter(game=="62716168a67e5db825954be9")))%>%
  ggplot(aes(id,time))+  
  geom_point()
user_summarise%>%mutate(time_game= end_game-start_game)%>%
  ggplot(aes(time_game,score, color=email))+
  geom_point()
```

